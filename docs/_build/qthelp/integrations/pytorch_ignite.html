<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Log PyTorch Ignite metrics to neptune</title>
    <link rel="stylesheet" href="../_static/nonav.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/custom.css" /> 
  </head><body>

    <div class="document">
      <div class="documentwrapper">
          <div class="body" role="main">
            
  <div class="section" id="log-pytorch-ignite-metrics-to-neptune">
<h1>Log PyTorch Ignite metrics to neptune</h1>
<a class="reference external image-reference" href="../_static/images/others/ignite_neptuneai.png"><img alt="PyTorch Ignite neptune.ai integration" src="../_images/ignite_neptuneai.png" /></a>
<div class="section" id="prerequisites">
<h2>Prerequisites</h2>
<p>Integration with <a href="https://github.com/pytorch/ignite" target="_blank">PyTorch Ignite</a> framework is introduced as a part of logging module so just need to have <a href="https://github.com/neptune-ai/neptune-client" target="_blank">neptune-client</a> installed.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pip install neptune-client
</pre></div>
</div>
</div>
<div class="section" id="create-the-neptunelogger-with-all-the-information-you-want-to-track">
<h2>Create the <strong>NeptuneLogger</strong> with all the information you want to track</h2>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ignite.contrib.handlers.neptune_logger</span> <span class="k">import</span> <span class="o">*</span>

<span class="n">npt_logger</span> <span class="o">=</span> <span class="n">NeptuneLogger</span><span class="p">(</span><span class="n">api_token</span><span class="o">=</span><span class="s2">&quot;ANONYMOUS&quot;</span><span class="p">,</span>
                           <span class="n">project_name</span><span class="o">=</span><span class="s1">&#39;shared/pytorch-ignite-integration&#39;</span><span class="p">,</span>
                           <span class="n">name</span><span class="o">=</span><span class="s1">&#39;ignite-mnist-example&#39;</span><span class="p">,</span>
                           <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;train_batch_size&#39;</span><span class="p">:</span> <span class="n">train_batch_size</span><span class="p">,</span>
                                   <span class="s1">&#39;val_batch_size&#39;</span><span class="p">:</span> <span class="n">val_batch_size</span><span class="p">,</span>
                                   <span class="s1">&#39;epochs&#39;</span><span class="p">:</span> <span class="n">epochs</span><span class="p">,</span>
                                   <span class="s1">&#39;lr&#39;</span><span class="p">:</span> <span class="n">lr</span><span class="p">,</span>
                                   <span class="s1">&#39;momentum&#39;</span><span class="p">:</span> <span class="n">momentum</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="section" id="attach-handlers-to-npt-logger">
<h2>Attach handlers to <strong>npt_logger</strong></h2>
<p>There are many handlers that you can attach to track your training.</p>
<p><strong>OutputHandler</strong> for tracking losses and metrics</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">npt_logger</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">trainer</span><span class="p">,</span>
                  <span class="n">log_handler</span><span class="o">=</span><span class="n">OutputHandler</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="s2">&quot;training&quot;</span><span class="p">,</span>
                                            <span class="n">output_transform</span><span class="o">=</span><span class="k">lambda</span> <span class="n">loss</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;batchloss&#39;</span><span class="p">:</span> <span class="n">loss</span><span class="p">},</span>
                                            <span class="n">metric_names</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">),</span>
                  <span class="n">event_name</span><span class="o">=</span><span class="n">Events</span><span class="o">.</span><span class="n">ITERATION_COMPLETED</span><span class="p">(</span><span class="n">every</span><span class="o">=</span><span class="mi">100</span><span class="p">))</span>

<span class="n">npt_logger</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">train_evaluator</span><span class="p">,</span>
                  <span class="n">log_handler</span><span class="o">=</span><span class="n">OutputHandler</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="s2">&quot;training&quot;</span><span class="p">,</span>
                                            <span class="n">metric_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;loss&quot;</span><span class="p">,</span> <span class="s2">&quot;accuracy&quot;</span><span class="p">],</span>
                                            <span class="n">another_engine</span><span class="o">=</span><span class="n">trainer</span><span class="p">),</span>
                  <span class="n">event_name</span><span class="o">=</span><span class="n">Events</span><span class="o">.</span><span class="n">EPOCH_COMPLETED</span><span class="p">)</span>

<span class="n">npt_logger</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">validation_evaluator</span><span class="p">,</span>
                  <span class="n">log_handler</span><span class="o">=</span><span class="n">OutputHandler</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="s2">&quot;validation&quot;</span><span class="p">,</span>
                                            <span class="n">metric_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;loss&quot;</span><span class="p">,</span> <span class="s2">&quot;accuracy&quot;</span><span class="p">],</span>
                                            <span class="n">another_engine</span><span class="o">=</span><span class="n">trainer</span><span class="p">),</span>
                  <span class="n">event_name</span><span class="o">=</span><span class="n">Events</span><span class="o">.</span><span class="n">EPOCH_COMPLETED</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>OptimizerParamsHandler</strong> for tracking optimizer parameters like learning rate and momentum.</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">npt_logger</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">trainer</span><span class="p">,</span>
                  <span class="n">log_handler</span><span class="o">=</span><span class="n">OptimizerParamsHandler</span><span class="p">(</span><span class="n">optimizer</span><span class="p">),</span>
                  <span class="n">event_name</span><span class="o">=</span><span class="n">Events</span><span class="o">.</span><span class="n">ITERATION_COMPLETED</span><span class="p">(</span><span class="n">every</span><span class="o">=</span><span class="mi">100</span><span class="p">))</span>
</pre></div>
</div>
<p><strong>WeightsScalarHandler</strong> for tracking the norm of model weights per layer.</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">npt_logger</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">trainer</span><span class="p">,</span>
                  <span class="n">log_handler</span><span class="o">=</span><span class="n">WeightsScalarHandler</span><span class="p">(</span><span class="n">model</span><span class="p">),</span>
                  <span class="n">event_name</span><span class="o">=</span><span class="n">Events</span><span class="o">.</span><span class="n">ITERATION_COMPLETED</span><span class="p">(</span><span class="n">every</span><span class="o">=</span><span class="mi">100</span><span class="p">))</span>
</pre></div>
</div>
<p><strong>GradsScalarHandler</strong> for tracking the norm of gradients per layer.</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">npt_logger</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">trainer</span><span class="p">,</span>
                  <span class="n">log_handler</span><span class="o">=</span><span class="n">GradsScalarHandler</span><span class="p">(</span><span class="n">model</span><span class="p">),</span>
                  <span class="n">event_name</span><span class="o">=</span><span class="n">Events</span><span class="o">.</span><span class="n">ITERATION_COMPLETED</span><span class="p">(</span><span class="n">every</span><span class="o">=</span><span class="mi">100</span><span class="p">))</span>
</pre></div>
</div>
<p><strong>NeptuneSaver</strong> for logging model checkpoints during training.</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ignite.handlers</span> <span class="k">import</span> <span class="n">Checkpoint</span>

<span class="k">def</span> <span class="nf">score_function</span><span class="p">(</span><span class="n">engine</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">engine</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span>

<span class="n">to_save</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="n">model</span><span class="p">}</span>
<span class="n">handler</span> <span class="o">=</span> <span class="n">Checkpoint</span><span class="p">(</span><span class="n">to_save</span><span class="p">,</span> <span class="n">NeptuneSaver</span><span class="p">(</span><span class="n">npt_logger</span><span class="p">),</span> <span class="n">n_saved</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                     <span class="n">filename_prefix</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">,</span> <span class="n">score_function</span><span class="o">=</span><span class="n">score_function</span><span class="p">,</span>
                     <span class="n">score_name</span><span class="o">=</span><span class="s2">&quot;validation_accuracy&quot;</span><span class="p">,</span>
                     <span class="n">global_step_transform</span><span class="o">=</span><span class="n">global_step_from_engine</span><span class="p">(</span><span class="n">trainer</span><span class="p">))</span>
<span class="n">validation_evaluator</span><span class="o">.</span><span class="n">add_event_handler</span><span class="p">(</span><span class="n">Events</span><span class="o">.</span><span class="n">COMPLETED</span><span class="p">,</span> <span class="n">handler</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="run-trainer">
<h2>Run trainer</h2>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">trainer</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">train_loader</span><span class="p">,</span> <span class="n">max_epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="log-additional-information">
<h2>Log additional information</h2>
<p>You can log any additional information directly to neptune experiment.
It can be accessed via <strong>npt_logger.experiment</strong>.</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="s1">&#39;model.pth&#39;</span><span class="p">)</span>
<span class="n">npt_logger</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">log_artifact</span><span class="p">(</span><span class="s1">&#39;model.pth&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="close-the-logger-after-you-are-finished-tracking">
<h2>Close the logger after you are finished tracking</h2>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">npt_logger</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="monitor-your-pytorch-ignite-training-in-neptune">
<h2>Monitor your PyTorch Ignite training in Neptune</h2>
<p>Now you can watch your pytorch-ignite model training in neptune!</p>
<p>Check this <a href="https://ui.neptune.ai/o/neptune-ai/org/pytorch-ignite-integration/e/PYTOR-30/charts" target="_blank">example experiment</a>.</p>
<a class="reference external image-reference" href="../_static/images/pytorch_ignite/pytorch_ignite_monitoring.gif"><img alt="PyTorch Ignite logging in neptune" src="../_images/pytorch_ignite_monitoring.gif" /></a>
</div>
<div class="section" id="full-pytorch-ignite-monitor-script">
<h2>Full PyTorch Ignite monitor script</h2>
<p>Simply copy and paste it to <code class="docutils literal notranslate"><span class="pre">ignite_example.py</span></code> and run.
Remember to change your credentials in the <strong>NeptuneLogger</strong>:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">npt_logger</span> <span class="o">=</span> <span class="n">NeptuneLogger</span><span class="p">(</span><span class="n">api_token</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;NEPTUNE_API_TOKEN&#39;</span><span class="p">),</span> <span class="c1"># put your api token in environment variable</span>
                           <span class="n">project_name</span><span class="o">=</span><span class="s1">&#39;neptune-ai/pytorch-ignite-integration&#39;</span><span class="p">,</span> <span class="c1"># change it to your project</span>
                           <span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="k">import</span> <span class="n">DataLoader</span>
<span class="kn">from</span> <span class="nn">torch</span> <span class="k">import</span> <span class="n">nn</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>
<span class="kn">from</span> <span class="nn">torch.optim</span> <span class="k">import</span> <span class="n">SGD</span>
<span class="kn">from</span> <span class="nn">torchvision.datasets</span> <span class="k">import</span> <span class="n">MNIST</span>
<span class="kn">from</span> <span class="nn">torchvision.transforms</span> <span class="k">import</span> <span class="n">Compose</span><span class="p">,</span> <span class="n">ToTensor</span><span class="p">,</span> <span class="n">Normalize</span>

<span class="kn">from</span> <span class="nn">ignite.engine</span> <span class="k">import</span> <span class="n">Events</span><span class="p">,</span> <span class="n">create_supervised_trainer</span><span class="p">,</span> <span class="n">create_supervised_evaluator</span>
<span class="kn">from</span> <span class="nn">ignite.metrics</span> <span class="k">import</span> <span class="n">Accuracy</span><span class="p">,</span> <span class="n">Loss</span>

<span class="kn">from</span> <span class="nn">ignite.contrib.handlers.neptune_logger</span> <span class="k">import</span> <span class="o">*</span>

<span class="n">LOG_INTERVAL</span> <span class="o">=</span> <span class="mi">10</span>


<span class="k">class</span> <span class="nc">Net</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Net</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv2_drop</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout2d</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">320</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">max_pool2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv1</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">max_pool2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv2_drop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv2</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">320</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fc1</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">F</span><span class="o">.</span><span class="n">log_softmax</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_data_loaders</span><span class="p">(</span><span class="n">train_batch_size</span><span class="p">,</span> <span class="n">val_batch_size</span><span class="p">):</span>
    <span class="n">data_transform</span> <span class="o">=</span> <span class="n">Compose</span><span class="p">([</span><span class="n">ToTensor</span><span class="p">(),</span> <span class="n">Normalize</span><span class="p">((</span><span class="mf">0.1307</span><span class="p">,),</span> <span class="p">(</span><span class="mf">0.3081</span><span class="p">,))])</span>

    <span class="n">train_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">MNIST</span><span class="p">(</span><span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">data_transform</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                              <span class="n">batch_size</span><span class="o">=</span><span class="n">train_batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">val_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">MNIST</span><span class="p">(</span><span class="n">download</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">data_transform</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                            <span class="n">batch_size</span><span class="o">=</span><span class="n">val_batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">train_loader</span><span class="p">,</span> <span class="n">val_loader</span>


<span class="n">train_batch_size</span> <span class="o">=</span> <span class="mi">64</span>
<span class="n">val_batch_size</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">epochs</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">lr</span> <span class="o">=</span> <span class="mf">0.01</span>
<span class="n">momentum</span> <span class="o">=</span> <span class="mf">0.5</span>

<span class="n">train_loader</span><span class="p">,</span> <span class="n">val_loader</span> <span class="o">=</span> <span class="n">get_data_loaders</span><span class="p">(</span><span class="n">train_batch_size</span><span class="p">,</span> <span class="n">val_batch_size</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">Net</span><span class="p">()</span>
<span class="n">device</span> <span class="o">=</span> <span class="s1">&#39;cpu&#39;</span>

<span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
    <span class="n">device</span> <span class="o">=</span> <span class="s1">&#39;cuda&#39;</span>

<span class="n">optimizer</span> <span class="o">=</span> <span class="n">SGD</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span> <span class="n">momentum</span><span class="o">=</span><span class="n">momentum</span><span class="p">)</span>
<span class="n">criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">()</span>
<span class="n">trainer</span> <span class="o">=</span> <span class="n">create_supervised_trainer</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="n">metrics</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="n">Accuracy</span><span class="p">(),</span>
    <span class="s1">&#39;loss&#39;</span><span class="p">:</span> <span class="n">Loss</span><span class="p">(</span><span class="n">criterion</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">train_evaluator</span> <span class="o">=</span> <span class="n">create_supervised_evaluator</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">metrics</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">validation_evaluator</span> <span class="o">=</span> <span class="n">create_supervised_evaluator</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">metrics</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>


<span class="nd">@trainer</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="n">Events</span><span class="o">.</span><span class="n">EPOCH_COMPLETED</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compute_metrics</span><span class="p">(</span><span class="n">engine</span><span class="p">):</span>
    <span class="n">train_evaluator</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">train_loader</span><span class="p">)</span>
    <span class="n">validation_evaluator</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">val_loader</span><span class="p">)</span>


<span class="n">npt_logger</span> <span class="o">=</span> <span class="n">NeptuneLogger</span><span class="p">(</span><span class="n">api_token</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">project_name</span><span class="o">=</span><span class="s2">&quot;neptune-ai/pytorch-ignite-integration&quot;</span><span class="p">,</span>
                           <span class="n">name</span><span class="o">=</span><span class="s1">&#39;ignite-mnist-example&#39;</span><span class="p">,</span>
                           <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;train_batch_size&#39;</span><span class="p">:</span> <span class="n">train_batch_size</span><span class="p">,</span>
                                   <span class="s1">&#39;val_batch_size&#39;</span><span class="p">:</span> <span class="n">val_batch_size</span><span class="p">,</span>
                                   <span class="s1">&#39;epochs&#39;</span><span class="p">:</span> <span class="n">epochs</span><span class="p">,</span>
                                   <span class="s1">&#39;lr&#39;</span><span class="p">:</span> <span class="n">lr</span><span class="p">,</span>
                                   <span class="s1">&#39;momentum&#39;</span><span class="p">:</span> <span class="n">momentum</span><span class="p">})</span>

<span class="n">npt_logger</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">trainer</span><span class="p">,</span>
                  <span class="n">log_handler</span><span class="o">=</span><span class="n">OutputHandler</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="s2">&quot;training&quot;</span><span class="p">,</span>
                                            <span class="n">output_transform</span><span class="o">=</span><span class="k">lambda</span> <span class="n">loss</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;batchloss&#39;</span><span class="p">:</span> <span class="n">loss</span><span class="p">},</span>
                                            <span class="n">metric_names</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">),</span>
                  <span class="n">event_name</span><span class="o">=</span><span class="n">Events</span><span class="o">.</span><span class="n">ITERATION_COMPLETED</span><span class="p">(</span><span class="n">every</span><span class="o">=</span><span class="mi">100</span><span class="p">))</span>

<span class="n">npt_logger</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">train_evaluator</span><span class="p">,</span>
                  <span class="n">log_handler</span><span class="o">=</span><span class="n">OutputHandler</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="s2">&quot;training&quot;</span><span class="p">,</span>
                                            <span class="n">metric_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;loss&quot;</span><span class="p">,</span> <span class="s2">&quot;accuracy&quot;</span><span class="p">],</span>
                                            <span class="n">another_engine</span><span class="o">=</span><span class="n">trainer</span><span class="p">),</span>
                  <span class="n">event_name</span><span class="o">=</span><span class="n">Events</span><span class="o">.</span><span class="n">EPOCH_COMPLETED</span><span class="p">)</span>

<span class="n">npt_logger</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">validation_evaluator</span><span class="p">,</span>
                  <span class="n">log_handler</span><span class="o">=</span><span class="n">OutputHandler</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="s2">&quot;validation&quot;</span><span class="p">,</span>
                                            <span class="n">metric_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;loss&quot;</span><span class="p">,</span> <span class="s2">&quot;accuracy&quot;</span><span class="p">],</span>
                                            <span class="n">another_engine</span><span class="o">=</span><span class="n">trainer</span><span class="p">),</span>
                  <span class="n">event_name</span><span class="o">=</span><span class="n">Events</span><span class="o">.</span><span class="n">EPOCH_COMPLETED</span><span class="p">)</span>

<span class="n">npt_logger</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">trainer</span><span class="p">,</span>
                  <span class="n">log_handler</span><span class="o">=</span><span class="n">OptimizerParamsHandler</span><span class="p">(</span><span class="n">optimizer</span><span class="p">),</span>
                  <span class="n">event_name</span><span class="o">=</span><span class="n">Events</span><span class="o">.</span><span class="n">ITERATION_COMPLETED</span><span class="p">(</span><span class="n">every</span><span class="o">=</span><span class="mi">100</span><span class="p">))</span>

<span class="n">npt_logger</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">trainer</span><span class="p">,</span>
                  <span class="n">log_handler</span><span class="o">=</span><span class="n">WeightsScalarHandler</span><span class="p">(</span><span class="n">model</span><span class="p">),</span>
                  <span class="n">event_name</span><span class="o">=</span><span class="n">Events</span><span class="o">.</span><span class="n">ITERATION_COMPLETED</span><span class="p">(</span><span class="n">every</span><span class="o">=</span><span class="mi">100</span><span class="p">))</span>

<span class="n">npt_logger</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">trainer</span><span class="p">,</span>
                  <span class="n">log_handler</span><span class="o">=</span><span class="n">GradsScalarHandler</span><span class="p">(</span><span class="n">model</span><span class="p">),</span>
                  <span class="n">event_name</span><span class="o">=</span><span class="n">Events</span><span class="o">.</span><span class="n">ITERATION_COMPLETED</span><span class="p">(</span><span class="n">every</span><span class="o">=</span><span class="mi">100</span><span class="p">))</span>

<span class="c1"># kick everything off</span>
<span class="n">trainer</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">train_loader</span><span class="p">,</span> <span class="n">max_epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">)</span>

<span class="c1"># log additional information</span>
<span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="s1">&#39;model.pth&#39;</span><span class="p">)</span>
<span class="n">npt_logger</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">log_artifact</span><span class="p">(</span><span class="s1">&#39;model.pth&#39;</span><span class="p">)</span>

<span class="n">npt_logger</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>


          </div>
      </div>
      <div class="clearer"></div>
    </div>


  <script src="/docker-config.js"></script>
  <script>
    /* !
     * JavaScript Cookie v2.2.1
     * https://github.com/js-cookie/js-cookie
     *
     * Copyright 2006, 2015 Klaus Hartl & Fagner Brack
     * Released under the MIT license
     *
     * Minified by jsDelivr using Terser v3.14.1.
     * Original file: /npm/js-cookie@2.2.1/src/js.cookie.js
     *
     * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
     */
    !function(e){var n;if("function"==typeof define&&define.amd&&(define(e),n=!0),"object"==typeof exports&&(module.exports=e(),n=!0),!n){var t=window.Cookies,o=window.Cookies=e();o.noConflict=function(){return window.Cookies=t,o}}}(function(){function e(){for(var e=0,n={};e<arguments.length;e++){var t=arguments[e];for(var o in t)n[o]=t[o]}return n}function n(e){return e.replace(/(%[0-9A-Z]{2})+/g,decodeURIComponent)}return function t(o){function r(){}function i(n,t,i){if("undefined"!=typeof document){"number"==typeof(i=e({path:"/"},r.defaults,i)).expires&&(i.expires=new Date(1*new Date+864e5*i.expires)),i.expires=i.expires?i.expires.toUTCString():"";try{var c=JSON.stringify(t);/^[\{\[]/.test(c)&&(t=c)}catch(e){}t=o.write?o.write(t,n):encodeURIComponent(String(t)).replace(/%(23|24|26|2B|3A|3C|3E|3D|2F|3F|40|5B|5D|5E|60|7B|7D|7C)/g,decodeURIComponent),n=encodeURIComponent(String(n)).replace(/%(23|24|26|2B|5E|60|7C)/g,decodeURIComponent).replace(/[\(\)]/g,escape);var f="";for(var u in i)i[u]&&(f+="; "+u,!0!==i[u]&&(f+="="+i[u].split(";")[0]));return document.cookie=n+"="+t+f}}function c(e,t){if("undefined"!=typeof document){for(var r={},i=document.cookie?document.cookie.split("; "):[],c=0;c<i.length;c++){var f=i[c].split("="),u=f.slice(1).join("=");t||'"'!==u.charAt(0)||(u=u.slice(1,-1));try{var a=n(f[0]);if(u=(o.read||o)(u,a)||n(u),t)try{u=JSON.parse(u)}catch(e){}if(r[a]=u,e===a)break}catch(e){}}return e?r[e]:r}}return r.set=i,r.get=function(e){return c(e,!1)},r.getJSON=function(e){return c(e,!0)},r.remove=function(n,t){i(n,"",e(t,{expires:-1}))},r.defaults={},r.withConverter=t,r}(function(){})});
  </script>

  <script>
    function initGA(isProduction) {
      if (!isProduction) {
        // eslint-disable-next-line no-console
        console.warn('GA will not load in development mode');
        return;
      }

      /* eslint-disable */
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-102823704-1', 'auto');
      ga('send', 'pageview');
      /* eslint-enable */
    }

    initGA(window.dockerConfig.isProduction);
  </script>

  <script>
    /* global heap, hj */

    var options = {
      devel: {
        appId: 569758,
      },
      prod: {
        appId: 569747,
      },
    };

    function initHotJar(isProduction) {
      var appId = getAppId(isProduction);

      appendHotJarScript(appId);
      tagRecording();
    }

    function appendHotJarScript(appId) {
      (function (h, o, t, j, a, r) {
        h.hj = h.hj || function () {
          (h.hj.q = h.hj.q || []).push(arguments);
        };
        h._hjSettings = {hjid: appId, hjsv: 5};
        a = o.getElementsByTagName('head')[0];
        r = o.createElement('script');
        r.async = 1;
        r.src = t + h._hjSettings.hjid + j + h._hjSettings.hjsv;
        a.appendChild(r);
      })(window, document, '//static.hotjar.com/c/hotjar-', '.js?sv=');
    }

    function getAppId(isProduction) {
      return isProduction ? options.prod.appId : options.devel.appId;
    }

    function tagRecording() {
      var TAG_RECORDING_DELAY = 5 * 1000;

      if (canSafelyTagRecording()) {
        hj('tagRecording', [ heap.identity ]);
      } else {

        // try until all needed libs and data is available
        window.setTimeout(tagRecording, TAG_RECORDING_DELAY);
      }
    }

    function canSafelyTagRecording() {
      return (
        typeof hj === 'function'
        && typeof heap === 'object'
        && typeof heap.identity === 'string'
        && heap.identity.length > 0
      );
    }

    initHotJar(window.dockerConfig.isProduction);
  </script>

  <script>
    function initIntercom(isProduction) {
      var options = {
        devel: {
          appId: 'wqilukic',
        },
        prod: {
          appId: 'yoy39he9',
        },
      };

      var username = window.Cookies.get('neptune-uid');

      window.intercomSettings = {
        app_id: getAppId(isProduction),
      };

      var isUsernamePreserved = typeof username === 'string' && username.length > 0;
      if (isUsernamePreserved) {
        window.intercomSettings.user_id = username;
      }

      function getAppId(isProduction) {
        return isProduction ? options.prod.appId : options.devel.appId;
      }


      // Intercom official integration code
      // eslint-disable-next-line
      (function(){var w=window;var ic=w.Intercom;if(typeof ic==="function"){ic('reattach_activator');ic('update',w.intercomSettings);}else{var d=document;var i=function(){i.c(arguments);};i.q=[];i.c=function(args){i.q.push(args);};w.Intercom=i;var l=function(){var s=d.createElement('script');s.type='text/javascript';s.async=true;s.src='https://widget.intercom.io/widget/wqilukic';var x=d.getElementsByTagName('script')[0];x.parentNode.insertBefore(s,x);};if(w.attachEvent){w.attachEvent('onload',l);}else{w.addEventListener('load',l,false);}}})();
      // Intercom official integration code
    }

    initIntercom(window.dockerConfig.isProduction);
  </script>


  </body>
</html>